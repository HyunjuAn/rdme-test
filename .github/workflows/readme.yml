name: Sync API definition & guides/reference to ReadMe

on:
  push:
    branches: [ "main" ]
    tags:     [ "v*", "V*" ]    # 태그 푸시도 실행
  workflow_dispatch: {}

jobs:
  sync:
    runs-on: ubuntu-latest
    environment: README
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 변경 파일 감지 (브랜치 푸시일 때만 의미 있음)
      - name: Detect changed files
        id: diff
        shell: bash
        run: |
          git fetch --tags
          OPENAPI_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -c '^docs/petstore\.json$' || true)
          DOCS_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -c '^docs/documentation/.*\.md$' || true)
          REF_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -c '^docs/reference/.*\.md$' || true)
          echo "openapi_changed=$OPENAPI_CHANGED" >> $GITHUB_OUTPUT
          echo "docs_changed=$DOCS_CHANGED" >> $GITHUB_OUTPUT
          echo "ref_changed=$REF_CHANGED" >> $GITHUB_OUTPUT

      # 버전/브랜치 결정
      - name: Resolve ReadMe version/branch
        id: branch
        shell: bash
        run: |
          FALLBACK="v1.0"
          BRANCH=""

          if [[ "${GITHUB_REF}" =~ ^refs/tags/ ]]; then
            BRANCH="${GITHUB_REF#refs/tags/}"
          else
            git fetch --tags
            LATEST_TAG=$(git tag -l 'v*' --sort=-v:refname | head -n1)
            if [ -n "$LATEST_TAG" ]; then
              BRANCH="$LATEST_TAG"
            elif [ -f "docs/petstore.json" ]; then
              VER=$(jq -r '.info.version // empty' docs/petstore.json || true)
              if [ -n "$VER" ]; then
                [[ "$VER" =~ ^v ]] && BRANCH="$VER" || BRANCH="v$VER"
              fi
            fi
            [ -z "$BRANCH" ] && BRANCH="$FALLBACK"
          fi

          # ReadMe는 보통 vX.Y(브랜치)/ vX.Y_1(릴리즈) 구조 → 패치는 잘라냄
          if [[ "$BRANCH" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            BRANCH="${BRANCH%.*}"   # v1.0.0 -> v1.0
          fi

          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "Using ReadMe branch: $BRANCH"

      # OpenAPI 업로드: 태그 푸시거나, 변경됐을 때 수행
      - name: Upload OpenAPI to ReadMe
        if: startsWith(github.ref, 'refs/tags/') || steps.diff.outputs.openapi_changed != '0'
        uses: readmeio/rdme@v10
        with:
          rdme: >
            openapi upload ./docs/petstore.json
            --key=${{ secrets.README_API_KEY }}
            --slug=${{ secrets.README_API_DEFINITION_SLUG }}
            --version=${{ steps.branch.outputs.branch }}

      # Guides 업로드: 태그 푸시거나, 변경됐을 때 수행
      - name: Sync Guides to ReadMe
        if: startsWith(github.ref, 'refs/tags/') || steps.diff.outputs.docs_changed != '0'
        uses: readmeio/rdme@v10
        with:
          rdme: >
            docs upload ./docs/documentation
            --key=${{ secrets.README_API_KEY }}
            --branch=${{ steps.branch.outputs.branch }}

      # Reference 업로드: 태그 푸시거나, 변경됐을 때 수행
      - name: Sync Reference Markdown to ReadMe
        if: startsWith(github.ref, 'refs/tags/') || steps.diff.outputs.ref_changed != '0'
        uses: readmeio/rdme@v10
        with:
          rdme: >
            reference upload ./docs/reference
            --key=${{ secrets.README_API_KEY }}
            --branch=${{ steps.branch.outputs.branch }}